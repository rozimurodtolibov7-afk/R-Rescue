<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-Rescue: Cognitive Flow (Fixed)</title>
    <style>
        :root { --core: #fff; --good: #2ecc71; --bad: #e74c3c; --neutral: #f1c40f; }
        body { margin: 0; background: #050508; overflow: hidden; font-family: 'Segoe UI', Tahoma, sans-serif; color: #fff; touch-action: none; }
        #ui { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-around; z-index: 10; pointer-events: none; }
        .stat { font-size: 14px; letter-spacing: 2px; font-weight: bold; }
        #core-health { width: 120px; height: 6px; background: #222; margin-top: 5px; border-radius: 3px; overflow: hidden; }
        #health-fill { width: 100%; height: 100%; background: var(--good); transition: 0.4s; }
        canvas { display: block; }
        .hint { position: absolute; bottom: 20px; width: 100%; text-align: center; font-size: 12px; opacity: 0.4; }
    </style>
</head>
<body>

<div id="ui">
    <div class="stat">SCORE: <span id="score">0</span></div>
    <div class="stat">INTEGRITY <div id="core-health"><div id="health-fill"></div></div></div>
</div>

<div class="hint">Qizil doiralarni barmog'ingiz bilan chetga suring</div>
<canvas id="flowCanvas"></canvas>

<script>
const canvas = document.getElementById('flowCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let nodes = [], score = 0, integrity = 100, gameActive = true;
const corePos = { x: canvas.width / 2, y: canvas.height / 2, r: 45 };

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(freq, type, vol = 0.05) {
    if (audioCtx.state === 'suspended') return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(vol, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
    o.start(); o.stop(audioCtx.currentTime + 0.2);
}

class Node {
    constructor() {
        this.reset();
    }
    reset() {
        const side = Math.floor(Math.random() * 4);
        if(side === 0) { this.x = Math.random()*canvas.width; this.y = -30; }
        else if(side === 1) { this.x = canvas.width+30; this.y = Math.random()*canvas.height; }
        else if(side === 2) { this.x = Math.random()*canvas.width; this.y = canvas.height+30; }
        else { this.x = -30; this.y = Math.random()*canvas.height; }

        this.type = Math.random() > 0.7 ? 'bad' : (Math.random() > 0.3 ? 'good' : 'neutral');
        // Tezlik sekinlashtirildi (0.6 dan 1.2 gacha)
        this.s = 0.6 + Math.random() * 0.6;
        this.r = 12;
        this.toRemove = false;
    }
    update() {
        const angle = Math.atan2(corePos.y - this.y, corePos.x - this.x);
        this.x += Math.cos(angle) * this.s;
        this.y += Math.sin(angle) * this.s;

        const dist = Math.sqrt((this.x - corePos.x)**2 + (this.y - corePos.y)**2);
        if(dist < corePos.r) {
            this.hitCore();
        }
    }
    hitCore() {
        if(this.type === 'good') {
            score += 10;
            playSound(600, 'sine');
        } else if(this.type === 'bad') {
            integrity -= 20;
            playSound(150, 'square', 0.1);
        } else {
            score += 5;
            playSound(400, 'sine');
        }
        this.toRemove = true;
    }
}

function draw() {
    if(!gameActive) return;

    ctx.fillStyle = 'rgba(5, 5, 8, 0.4)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Yadro chizmasi
    ctx.strokeStyle = integrity > 30 ? '#fff' : '#e74c3c';
    ctx.lineWidth = 3;
    ctx.shadowBlur = 15;
    ctx.shadowColor = ctx.strokeStyle;
    ctx.beginPath(); 
    ctx.arc(corePos.x, corePos.y, corePos.r + Math.sin(Date.now()/300)*3, 0, Math.PI*2); 
    ctx.stroke();
    ctx.shadowBlur = 0;

    // Doiralarni yangilash va chizish
    for (let i = nodes.length - 1; i >= 0; i--) {
        let n = nodes[i];
        n.update();
        
        ctx.fillStyle = n.type === 'good' ? '#2ecc71' : (n.type === 'bad' ? '#e74c3c' : '#f1c40f');
        ctx.beginPath(); 
        ctx.arc(n.x, n.y, n.r, 0, Math.PI*2); 
        ctx.fill();

        if (n.toRemove) {
            nodes.splice(i, 1);
        }
    }

    // UI yangilash
    document.getElementById('score').innerText = score;
    document.getElementById('health-fill').style.width = integrity + '%';
    if(integrity <= 0) gameOver();

    // Doira yaratish tezligi (Sekinlashtirildi)
    if(Math.random() < 0.02) nodes.push(new Node());

    requestAnimationFrame(draw);
}

// Qizil doiralarni barmog'ingiz bilan o'chirib tashlash (Filter)
const handleInput = (e) => {
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
    
    if (audioCtx.state === 'suspended') audioCtx.resume();

    for (let i = nodes.length - 1; i >= 0; i--) {
        let n = nodes[i];
        const d = Math.sqrt((clientX - n.x)**2 + (clientY - n.y)**2);
        
        if(d < 50 && n.type === 'bad') {
            nodes.splice(i, 1);
            score += 5;
            playSound(800, 'sine', 0.03);
            break; 
        }
    }
};

canvas.addEventListener('pointermove', handleInput);
canvas.addEventListener('touchstart', handleInput);

function gameOver() {
    gameActive = false;
    alert("ONG YADROSI BUZILDI!\nTo'plangan bilim: " + score);
    location.reload();
}

draw();
</script>
</body>
</html>